---
title: "[eb1] Measurement - Quality Control"
author: "Egor Ananyev"
date: "2019-01-04"
output:
    html_document:
        toc: true
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
body, td{
  font-family: Cambria;
}
code.r{
  font-family: Inconsolata;
}
</style>

# Data input and parsing
```{r set-options, message=F}
options(width=100)
dropbox_dir = '/Users/Egor/Dropbox/' # Mac / Toshi
# dropbox_dir = '/Users/egora/Dropbox/' # Shocky
data_dir = paste0(dropbox_dir, 'Projects/eb/data/eb1')
this_subj = 'subj-00'
this_cond = 'cond-m'
cond_dir = paste(data_dir, this_subj, this_cond, sep='/')
all_data_dirs = list.dirs(cond_dir)[-1]  # excluding the first (base) directory
# TEMP: for now, just taking the last directory:
this_data_dir = all_data_dirs[length(all_data_dirs)]
file_name = dir(this_data_dir, pattern='.asc')
file_path = paste(this_data_dir, file_name, sep='/')
```

```{r}
# Read in the data:
raw_data = readLines(gzfile(file_path))  # gzfile unpacks .gz

# This function converts a specific chunk of raw data into a numeric data frame.
dfy = function(df_in, cols){
    ## The 'max_col' parameter identifies the number of columns to capture
    # First, we split the dataset by the tab '\t' delimeter:
    df_out = do.call(rbind, strsplit(df_in, '\t'))[,cols]
    # We then convert the resulting character matrix into a numeric data frame:
    if(is.null(dim(df_out))){  # if there is only a single dimension (i.e., a list), no need for 'apply'
        df_out = as.numeric(df_out)
    }else{  # otherwise, 'apply'ing 'as.numeric' conversion to columns:
        # To avoid the 'conversion to NA' warning, preassigning blink-related blank cells to NAs:
        df_out[df_out=='   .'] = NA
        df_out = data.frame(apply(df_out, 2, as.numeric))
    }
}
```

## Samples
```{r}
# extracting lines that start with numbers:
samples = raw_data[grepl('^[0-9]', raw_data)]
# creating a proper data frame:
df_samples = dfy(samples, 1:4)  # we only need 4 cols
colnames(df_samples) = c('time', 'xr', 'yr', 'psr')
print(head(df_samples))
```

## Trial times
```{r}
# Storing the start and end trials times for later labeling
df_trials = data.frame(start=dfy(raw_data[grepl('^START', raw_data)], 2),
                       end=dfy(raw_data[grepl('^END', raw_data)], 2))
print(df_trials)
# Labeling trials in the 'samples' data frame
for(cur_trial in 1:nrow(df_trials)){
    df_samples$trial[df_samples$time >= df_trials$start[cur_trial]] = cur_trial # &
                         # df_samples$time <= df_trials$end[cur_trial]] = cur_trial
}
```

## Blank events
```{r}
# Extracting the lines with blank ends, as they include blank start, end, and duration:
blanks = raw_data[grepl('^EBLINK', raw_data)]
df_blanks = data.frame(do.call(rbind, strsplit(blanks, "\t", fixed=TRUE)))
df_blanks = cbind(df_blanks,
                  data.frame(do.call(rbind, strsplit(as.character(df_blanks[,1]), " ",
                                                     fixed=TRUE))))
df_blanks = df_blanks[,c(5,6,2,3)]
colnames(df_blanks) = c('eye', 'start', 'end', 'dur')
df_blanks[,2:4] = data.frame(apply(df_blanks[,2:4], 2, as.numeric))
# Labeling trials in the 'blanks' data frame
for(cur_trial in 1:nrow(df_trials)){
    df_blanks$trial[df_blanks$start >= df_trials$start[cur_trial]] = cur_trial # &
                         # df_samples$time <= df_trials$end[cur_trial]] = cur_trial
}
print(head(df_blanks))
# TODO: the blank durations tend to be overestimated by 2 units
```

# Visualization for QC
```{r, fig.width=4.5, fig.height=3}
library(ggplot2)
# For simplicity, only visualizing the right eye at the moment:
for(cur_trial in 1:nrow(df_trials)){
    p = ggplot(df_samples[df_samples$trial==cur_trial,], aes(x=time))
    p = p + geom_line(aes(y=yr, colour='Gaze'))
    p = p + geom_line(aes(y=psr/5, colour='Pupil'))
    p = p + scale_y_continuous(sec.axis = sec_axis(~.*5, name='Pupil Diameter (a.u.)'))
    p = p + scale_colour_manual(values=c('blue', 'red'))
    p = p + theme(legend.position = c(0.15, 0.2))
    # number of blanks in this trial:
    numof_blanks = sum(df_blanks$trial==cur_trial)
    if(numof_blanks >= 1){
        cur_blanks = df_blanks[df_blanks$trial==cur_trial,]
        for(cur_blank in 1:numof_blanks){
            p = p + geom_rect(data=cur_blanks[cur_blank,], inherit.aes=F, 
                              aes(xmin=start, xmax=end, ymin=-500, ymax=1500),
                              color='transparent', fill='red', alpha=.3)
        }
    }
    p = p + labs(y='Gaze Y-Position', x='Time', colour='Parameter')
    print(p)
}
    # p = ggplot(df_samples[df_samples$trial==cur_trial,], aes(x=time, y=yr)) + 
    #     geom_line() + ylim(350, 600) + geom_rect(data=df_blanks[cur_trial,], inherit.aes=F, 
    #                                              aes(xmin=start, xmax=end, ymin=350, ymax=600),
    #                                              color='transparent', fill='red', alpha=.3)
```

# Trial exclusions
```{r}
trials_to_exclude = NULL
# trials_to_exclude = c(5, 7:10)
write.table(trials_to_exclude, paste(this_data_dir, 'measure_exclude.csv', sep='/'),
            row.names=F, col.names=F)
```